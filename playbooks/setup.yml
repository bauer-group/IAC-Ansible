---
# =============================================================================
# IAC-Ansible: Initial Host Setup Playbook
# =============================================================================
# Run this once on new hosts to bootstrap them into the IAC system.
# After initial setup, hosts will self-manage via ansible-pull.
#
# Usage:
#   ansible-playbook playbooks/setup.yml --limit "new-host.example.com"
#   ansible-playbook playbooks/setup.yml -e "ansible_user=ubuntu ansible_ssh_pass=..."
# =============================================================================

- name: Initial host bootstrap
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display bootstrap information
      ansible.builtin.debug:
        msg: >
          Bootstrapping {{ inventory_hostname }}
          | OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          | Architecture: {{ ansible_architecture }}

    - name: Wait for system to be reachable
      ansible.builtin.wait_for_connection:
        timeout: 300

  roles:
    - role: common
    - role: ansible_pull

  post_tasks:
    - name: Trigger initial ansible-pull run
      ansible.builtin.systemd:
        name: ansible-pull.service
        state: started

    - name: Bootstrap complete
      ansible.builtin.debug:
        msg: >
          Host {{ inventory_hostname }} bootstrapped successfully.
          ansible-pull timer is active and will check for updates on schedule:
          {{ ansible_pull_schedule }}
