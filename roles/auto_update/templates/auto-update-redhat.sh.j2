#!/bin/bash
# =============================================================================
# IAS-Ansible: Automatic System Update Script (RedHat/CentOS)
# Managed by Ansible - DO NOT EDIT MANUALLY
# =============================================================================

set -euo pipefail

LOG_PREFIX="[IAS-AutoUpdate]"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "${LOG_PREFIX} ${TIMESTAMP} Starting system update..."
echo "${LOG_PREFIX} Update type: {{ auto_update_type }}"
echo "${LOG_PREFIX} Host: $(hostname -f)"

{% if auto_update_type == "security" %}
# Security updates only
echo "${LOG_PREFIX} Installing security updates only..."
dnf update -y --security 2>/dev/null || yum update -y --security
{% else %}
# Full system update
echo "${LOG_PREFIX} Installing all available updates..."
dnf update -y 2>/dev/null || yum update -y
{% endif %}

{% if auto_update_autoremove | bool %}
# Remove unused packages
echo "${LOG_PREFIX} Removing unused packages..."
dnf autoremove -y 2>/dev/null || yum autoremove -y 2>/dev/null || true
{% endif %}

# Check if reboot is required
if needs-restarting -r &>/dev/null; then
    echo "${LOG_PREFIX} No reboot required"
else
    echo "${LOG_PREFIX} NOTICE: System reboot required"
    echo "${LOG_PREFIX} Reboot will be handled by scheduled reboot cron"
fi

TIMESTAMP_END=$(date '+%Y-%m-%d %H:%M:%S')
echo "${LOG_PREFIX} ${TIMESTAMP_END} Update completed successfully"
