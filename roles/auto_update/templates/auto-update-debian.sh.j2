#!/bin/bash
# =============================================================================
# IAC-Ansible: Automatic System Update Script (Debian/Ubuntu)
# Managed by Ansible - DO NOT EDIT MANUALLY
# =============================================================================

set -euo pipefail

LOG_PREFIX="[IAC-AutoUpdate]"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "${LOG_PREFIX} ${TIMESTAMP} Starting system update..."
echo "${LOG_PREFIX} Update type: {{ auto_update_type }}"
echo "${LOG_PREFIX} Host: $(hostname -f)"

# Update package lists
echo "${LOG_PREFIX} Updating package lists..."
apt-get update -qq

{% if auto_update_type == "security" %}
# Security updates only via unattended-upgrades (reliable method)
echo "${LOG_PREFIX} Installing security updates only..."
unattended-upgrade -v 2>&1 || {
    echo "${LOG_PREFIX} Fallback: using apt with security pocket..."
    DISTRO=$(lsb_release -cs 2>/dev/null || . /etc/os-release && echo "${VERSION_CODENAME}")
    apt-get upgrade -y \
        -o Dpkg::Options::="--force-confdef" \
        -o Dpkg::Options::="--force-confold" \
        -o Dir::Etc::sourcelist="/etc/apt/sources.list" \
        -t "${DISTRO}-security" 2>/dev/null || true
}
{% else %}
# Full system upgrade
echo "${LOG_PREFIX} Installing all available updates..."
apt-get upgrade -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold"
apt-get dist-upgrade -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold"
{% endif %}

{% if auto_update_autoremove | bool %}
# Remove unused packages
echo "${LOG_PREFIX} Removing unused packages..."
apt-get autoremove -y
apt-get autoclean -y
{% endif %}

{% if auto_update_remove_old_kernels | bool %}
# Remove old kernels (keep current + one previous)
echo "${LOG_PREFIX} Cleaning old kernels..."
apt-get autoremove --purge -y 2>/dev/null || true
{% endif %}

# Check if reboot is required
if [ -f /var/run/reboot-required ]; then
    echo "${LOG_PREFIX} NOTICE: System reboot required"
    echo "${LOG_PREFIX} Reboot will be handled by scheduled reboot cron"
else
    echo "${LOG_PREFIX} No reboot required"
fi

TIMESTAMP_END=$(date '+%Y-%m-%d %H:%M:%S')
echo "${LOG_PREFIX} ${TIMESTAMP_END} Update completed successfully"
