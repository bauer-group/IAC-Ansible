#!/bin/bash
# =============================================================================
# IAC-Ansible: Controlled Reboot Script
# Managed by Ansible - DO NOT EDIT MANUALLY
# =============================================================================

set -euo pipefail

LOG_PREFIX="[IAC-AutoReboot]"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "${LOG_PREFIX} ${TIMESTAMP} Checking if reboot is required..."

NEEDS_REBOOT=false

{% if ansible_os_family == "Debian" %}
# Debian/Ubuntu: check reboot-required flag
if [ -f /var/run/reboot-required ]; then
    NEEDS_REBOOT=true
    echo "${LOG_PREFIX} /var/run/reboot-required exists"
    if [ -f /var/run/reboot-required.pkgs ]; then
        echo "${LOG_PREFIX} Packages requiring reboot:"
        cat /var/run/reboot-required.pkgs
    fi
fi
{% else %}
# RedHat/CentOS: use needs-restarting
if ! needs-restarting -r &>/dev/null; then
    NEEDS_REBOOT=true
    echo "${LOG_PREFIX} needs-restarting reports reboot required"
fi
{% endif %}

if [ "${NEEDS_REBOOT}" = true ]; then
    echo "${LOG_PREFIX} Reboot required. Running pre-reboot health checks..."

{% if ansible_os_family == "Debian" %}
    # Check: dpkg in consistent state (no interrupted installs)
    if dpkg --audit 2>&1 | grep -q .; then
        echo "${LOG_PREFIX} ABORT: dpkg audit found inconsistencies. Fix manually:"
        dpkg --audit
        logger -t IAC-Ansible "Reboot ABORTED: dpkg audit failed"
        exit 1
    fi

    # Check: no dpkg lock held (update still running)
    if fuser /var/lib/dpkg/lock-frontend &>/dev/null; then
        echo "${LOG_PREFIX} ABORT: dpkg lock held, package operation in progress"
        logger -t IAC-Ansible "Reboot ABORTED: dpkg lock held"
        exit 1
    fi
{% else %}
    # Check: no rpm transaction in progress
    if [ -f /var/lib/rpm/.rpm.lock ] && fuser /var/lib/rpm/.rpm.lock &>/dev/null; then
        echo "${LOG_PREFIX} ABORT: rpm lock held, package operation in progress"
        logger -t IAC-Ansible "Reboot ABORTED: rpm lock held"
        exit 1
    fi
{% endif %}

    # Check: system load not critical (avoid reboot during high load)
    LOAD=$(awk '{print $1}' /proc/loadavg)
    CPUS=$(nproc)
    if awk "BEGIN {exit !(${LOAD} > ${CPUS} * 3)}"; then
        echo "${LOG_PREFIX} ABORT: System load too high (${LOAD}, ${CPUS} CPUs)"
        logger -t IAC-Ansible "Reboot ABORTED: high load (${LOAD})"
        exit 1
    fi

    echo "${LOG_PREFIX} Health checks passed. Initiating controlled reboot..."
    echo "${LOG_PREFIX} Reboot reason: Scheduled maintenance (IAC-Ansible auto-update)"

    # Log to syslog
    logger -t IAC-Ansible "Controlled reboot initiated by auto-update schedule"

    # Perform reboot with 1 minute warning
    shutdown -r +1 "IAC-Ansible: Scheduled reboot for system updates"
else
    echo "${LOG_PREFIX} No reboot required. Skipping."
fi
