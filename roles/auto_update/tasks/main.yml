---
# =============================================================================
# Auto-Update Role - Main Tasks
# =============================================================================
# Maintenance chain: ansible-pull → system update → conditional reboot
# All phases run sequentially from a single cron trigger.

- name: Display auto-update configuration
  ansible.builtin.debug:
    msg: >
      Auto-Update Config for {{ inventory_hostname }}:
      enabled={{ auto_update_enabled }}
      | type={{ auto_update_type }}
      | chain_ansible_pull={{ auto_update_chain_ansible_pull }}
      | reboot={{ auto_update_reboot_enabled }} (weekday={{ auto_update_reboot_cron_weekday }})
      | schedule={{ auto_update_cron_minute }} {{ auto_update_cron_hour }} {{ auto_update_cron_day }} {{ auto_update_cron_month }} {{ auto_update_cron_weekday }}

- name: Include Debian/Ubuntu auto-update tasks
  ansible.builtin.include_tasks: debian.yml
  when: ansible_os_family == "Debian" and auto_update_enabled | bool

- name: Include RedHat/CentOS auto-update tasks
  ansible.builtin.include_tasks: redhat.yml
  when: ansible_os_family == "RedHat" and auto_update_enabled | bool

# --- Cleanup legacy separate reboot cron/script ---

- name: Remove legacy reboot cron job (now part of maintenance chain)
  ansible.builtin.cron:
    name: "IAC-Ansible: Controlled reboot"
    state: absent

- name: Remove legacy reboot script
  ansible.builtin.file:
    path: /usr/local/sbin/auto-reboot.sh
    state: absent

# --- Disable tasks when auto_update is off ---

- name: Remove update cron when disabled
  ansible.builtin.cron:
    name: "IAC-Ansible: Auto system update"
    state: absent
  when: not (auto_update_enabled | bool)
