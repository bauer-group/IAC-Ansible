---
# =============================================================================
# SSH Key Deployment + Hardening (idiot-proof)
# =============================================================================
# Flow:
#   1. Fetch SSH keys from GitHub profiles
#   2. Combine with vault-encrypted extra keys
#   3. Deploy to authorized_keys
#   4. VERIFY keys are actually present
#   5. Only THEN harden sshd_config
#
# Safety: REFUSES to harden if no keys end up in authorized_keys.

# --- Step 1: Determine home directory ---

- name: "[SSH] Determine home directory"
  ansible.builtin.set_fact:
    common_ssh_home: >-
      {{ '/root' if common_ssh_authorized_keys_user == 'root'
      else '/home/' + common_ssh_authorized_keys_user }}

# --- Step 2: Fetch GitHub keys ---

- name: "[SSH] Fetch keys from GitHub"
  ansible.builtin.uri:
    url: "https://github.com/{{ item }}.keys"
    return_content: true
    timeout: 10
  register: common_ssh_github_results
  loop: "{{ common_ssh_github_users }}"
  failed_when: false
  when: common_ssh_github_users | length > 0

- name: "[SSH] Collect GitHub keys"
  ansible.builtin.set_fact:
    common_ssh_collected_github_keys: >-
      {{ common_ssh_github_results.results | default([])
         | selectattr('status', 'defined')
         | selectattr('status', 'equalto', 200)
         | map(attribute='content')
         | map('trim')
         | select()
         | list }}

- name: "[SSH] Report GitHub key fetch results"
  ansible.builtin.debug:
    msg: >-
      GitHub keys: {{ common_ssh_github_users | length }} user(s) requested,
      {{ common_ssh_collected_github_keys | length }} responded with keys
  when: common_ssh_github_users | length > 0

# --- Step 3: Build final key list ---

- name: "[SSH] Build authorized_keys content"
  ansible.builtin.set_fact:
    common_ssh_all_keys: >-
      {{ (common_ssh_collected_github_keys | default([]))
         + (common_ssh_extra_keys | default([])) }}

- name: "[SSH] ABORT - No SSH keys from any source"
  ansible.builtin.fail:
    msg: >-
      SSH hardening ABORTED for {{ inventory_hostname }}!
      No SSH keys found from GitHub users ({{ common_ssh_github_users | join(', ') }})
      and no extra keys configured (common_ssh_extra_keys).
      Deploy SSH keys first, then enable common_ssh_hardening.
  when: common_ssh_all_keys | length == 0

# --- Step 4: Deploy keys ---

- name: "[SSH] Ensure .ssh directory exists"
  ansible.builtin.file:
    path: "{{ common_ssh_home }}/.ssh"
    state: directory
    owner: "{{ common_ssh_authorized_keys_user }}"
    mode: "0700"

- name: "[SSH] Deploy authorized_keys"
  ansible.builtin.template:
    src: authorized_keys.j2
    dest: "{{ common_ssh_home }}/.ssh/authorized_keys"
    owner: "{{ common_ssh_authorized_keys_user }}"
    mode: "0600"

# --- Step 5: Verify keys are present ---

- name: "[SSH] Verify authorized_keys not empty"
  ansible.builtin.command:
    cmd: "grep -c '^ssh-' {{ common_ssh_home }}/.ssh/authorized_keys"
  register: common_ssh_verify_count
  changed_when: false

- name: "[SSH] ABORT - authorized_keys empty after deploy"
  ansible.builtin.fail:
    msg: >-
      SSH hardening ABORTED for {{ inventory_hostname }}!
      authorized_keys file exists but contains no valid keys.
      This should not happen - check GitHub usernames and extra keys.
  when: (common_ssh_verify_count.stdout | int) == 0

- name: "[SSH] Keys verified"
  ansible.builtin.debug:
    msg: >-
      SSH: {{ common_ssh_verify_count.stdout }} key(s) deployed
      for '{{ common_ssh_authorized_keys_user }}', proceeding with hardening

# --- Step 6: Harden sshd ---

- name: "[SSH] Check sshd_config.d support"
  ansible.builtin.stat:
    path: /etc/ssh/sshd_config.d
  register: common_ssh_confd

- name: "[SSH] Deploy hardening config (drop-in)"
  ansible.builtin.template:
    src: sshd_hardening.conf.j2
    dest: /etc/ssh/sshd_config.d/99-iac-hardening.conf
    mode: "0644"
    validate: "sshd -t -f %s"
  notify: Restart sshd
  when: common_ssh_confd.stat.isdir | default(false)

- name: "[SSH] Deploy hardening config (legacy sshd_config)"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    validate: "sshd -t -f %s"
  loop:
    - regexp: "^#?PermitRootLogin"
      line: "PermitRootLogin {{ common_ssh_permit_root_login }}"
    - regexp: "^#?PasswordAuthentication"
      line: "PasswordAuthentication {{ common_ssh_password_authentication }}"
  notify: Restart sshd
  when: not (common_ssh_confd.stat.isdir | default(false))
