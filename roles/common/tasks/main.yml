---
# =============================================================================
# Common Role - Main Tasks
# =============================================================================
# Platform detection and delegation to OS-specific tasks

- name: Gather OS family variables
  ansible.builtin.include_vars: "{{ ansible_os_family }}.yml"

- name: Display detected platform
  ansible.builtin.debug:
    msg: >
      Host: {{ inventory_hostname }}
      | OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      | Family: {{ ansible_os_family }}
      | Architecture: {{ ansible_architecture }}

- name: Include Debian/Ubuntu tasks
  ansible.builtin.include_tasks: debian.yml
  when: ansible_os_family == "Debian"

- name: Include RedHat/CentOS tasks
  ansible.builtin.include_tasks: redhat.yml
  when: ansible_os_family == "RedHat"

- name: Fail on unsupported platform
  ansible.builtin.fail:
    msg: "Unsupported OS family: {{ ansible_os_family }}. Supported: Debian, RedHat"
  when: ansible_os_family not in ["Debian", "RedHat"]

# --- Common tasks (all platforms) ---

- name: Set timezone
  community.general.timezone:
    name: "{{ system_timezone }}"
  when: common_timezone_configure | bool

- name: Gather service facts for NTP detection
  ansible.builtin.service_facts:
  when: common_ntp_configure | bool and ntp_enabled | bool

- name: Set NTP already active fact
  ansible.builtin.set_fact:
    common_ntp_already_active: >-
      {{
        (ansible_facts.services['chronyd.service'] | default({})).get('state') == 'running' or
        (ansible_facts.services['chrony.service'] | default({})).get('state') == 'running' or
        (ansible_facts.services['ntpd.service'] | default({})).get('state') == 'running' or
        (ansible_facts.services['ntp.service'] | default({})).get('state') == 'running'
      }}
  when: common_ntp_configure | bool and ntp_enabled | bool

- name: Deploy timesyncd configuration
  ansible.builtin.template:
    src: timesyncd.conf.j2
    dest: /etc/systemd/timesyncd.conf
    mode: "0644"
  notify: Restart timesyncd
  when:
    - common_ntp_configure | bool
    - ntp_enabled | bool
    - ntp_servers is defined
    - not (common_ntp_already_active | default(false) | bool)

- name: Enable and start NTP service
  ansible.builtin.systemd:
    name: "{{ common_ntp_service }}"
    state: started
    enabled: true
  when:
    - common_ntp_configure | bool
    - ntp_enabled | bool
    - not (common_ntp_already_active | default(false) | bool)

- name: Create Ansible log directory
  ansible.builtin.file:
    path: /var/log/ansible
    state: directory
    mode: "0755"
  when: common_logdir_configure | bool

- name: Deploy MOTD
  ansible.builtin.template:
    src: motd.j2
    dest: /etc/motd
    mode: "0644"
  when: common_motd_configure | bool and motd_enabled | bool

- name: Include SSH hardening
  ansible.builtin.include_tasks: ssh_hardening.yml
  when: common_ssh_hardening | bool
