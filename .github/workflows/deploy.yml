---
name: ğŸš€ Deploy Configuration

on:
  push:
    branches: [main]
    paths:
      - 'roles/**'
      - 'playbooks/**'
      - 'inventory/**'
      - 'filter_plugins/**'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target hosts (limit pattern)'
        required: false
        default: 'all'

permissions:
  contents: read

# This workflow notifies managed hosts to pull updates.
# Requires SSH_PRIVATE_KEY secret with access to managed hosts.
# Enable this workflow once you have set up the secret.

jobs:
  notify:
    name: ğŸ“¡ Notify Hosts to Pull Updates
    runs-on: ubuntu-latest
    if: false  # Set to true once SSH_PRIVATE_KEY secret is configured

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: ğŸ Set up Python & Ansible
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: ğŸ“¦ Install Ansible
        run: |
          pip install ansible

      - name: ğŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Extract hostnames from inventory using ansible
          ansible-inventory -i inventory/production/hosts.yml --list \
            | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          hosts = set()
          for h in data.get('_meta', {}).get('hostvars', {}).keys():
              hosts.add(h)
          for h in hosts:
              print(h)
          " | while read -r host; do
            ssh-keyscan -H "${host}" >> ~/.ssh/known_hosts 2>/dev/null || true
          done

      - name: ğŸ”„ Trigger ansible-pull on hosts
        run: |
          TARGET="${{ github.event.inputs.target || 'all' }}"
          ansible -i inventory/production/hosts.yml "${TARGET}" \
            -m ansible.builtin.systemd \
            -a "name=ansible-pull.service state=started" \
            --become \
            || echo "âš ï¸ Some hosts may be unreachable - they will pull on next scheduled run"

      - name: ğŸ§¹ Cleanup SSH key
        if: always()
        run: |
          rm -rf ~/.ssh/id_rsa
